<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ingelheim Fahrplan</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Vithkuqi:wght@500&family=Nunito+Sans:opsz@6..12&family=Poppins:wght@400;500&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#ffffff">
  <style>
      *{margin:0px; padding:0px;}
      body{
          background: rgb(255,214,255);
          background: linear-gradient(0deg, rgba(255,214,255,1) 0%, rgba(231,198,255,1) 50%, rgba(200,182,255,1) 100%);
          font-family: 'Noto Serif Vithkuqi', serif;
          font-family: 'Nunito Sans', sans-serif;
          font-family: 'Poppins', sans-serif;
          padding-top: 75px;
          min-height: 100vh;
      }
      h1{
          display: flex;
          position: fixed;
          top:0px;
          color:#323232;
          background: white;
          font-size: 24px;
          padding: 18px 15px;
          width: 100%;
          -webkit-box-shadow: -5px 10px 13px -12px rgba(0,0,0,0.43);
          -moz-box-shadow: -5px 10px 13px -12px rgba(0,0,0,0.43);
          box-shadow: -5px 10px 13px -12px rgba(0,0,0,0.43);
          align-items: center;
      }
      .card {
          background: white;
          color:#443f3f;
          padding: 15px 10px;
          border: 1px solid #ddd;
          border-radius: 14px;
          margin: 10px;
          display: flex;
          justify-content:space-around;
          -webkit-box-shadow: -5px 9px 13px -12px rgba(0,0,0,0.43);
          -moz-box-shadow: -5px 9px 13px -12px rgba(0,0,0,0.43);
          box-shadow: -5px 9px 13px -12px rgba(0,0,0,0.43);
      }
      .card h2{
          font-size: 25px;

      }
      .card h3{
          font-size: 14px;
          font-weight: normal;
          overflow: hidden;
          white-space: nowrap;
          text-overflow: ellipsis;
          width: 90%;
      }
      .card h4{
          font-size: 12px;
      }
      .time{
          color: #61ad30;
          width: 80px;
          padding-right: 10px;
          border-right: 1px solid #ccc;
          display: flex;
          align-items: center;
          flex-direction: column;
          justify-content: center;
      }
      .gleis{
          width: 64px;
          font-weight: bold;
          font-size: 25px;
          display: flex;
          align-content: center;
          align-items: center;
          border-left: 1px solid #ccc;
          flex-direction: column;
      }

      .gleis small{
          font-size: 13px;
      }
      .info{
          margin-left: 10px;
          width: calc(100% - 160px);
      }
      .time.delayed{
          color: #ff5b12;
      }

      #time{
          margin-left: 15%;
      }

      .change-color{
          width: 32px;
          height:32px;
          border:none;
          border-radius: 50%;
          margin-right: 30px;
          background: #fff url("./dark-mode.png")  no-repeat center;
          background-size: contain;
      }
      .dark-mode {
          background: rgb(0,0,0);
          background: linear-gradient(0deg, rgba(0,0,0,1) 0%, rgba(40,40,40,1) 50%, rgba(54,54,54,1) 100%);
      }

      .dark-mode h1{
          background: #000;
          color:white;
      }
      .dark-mode .card{
          color: white;
          background: #05171f;
          border: 1px solid #09190b;
      }
      .dark-mode .change-color{
      }

  </style>
</head>
<body>


<h1>
  <button class="change-color" id="change-color"></button>
  Ingelheim Hbf <span id="time"></span>
</h1>

<div id="table-container"></div>


<script>
  function displayCurrentHour() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');

    const timeString = `${hours}:${minutes}`;
    document.getElementById('time').innerText = timeString;
  }

  async function fetchDataAndBuildTable() {
    displayCurrentHour();
    try {
      const response = await fetch('https://fahrplan-ics4sb2gxa-uc.a.run.app/');
      const rawJSON = await response.text();

      const cleanedJSON = rawJSON.replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
      const data = JSON.parse(cleanedJSON);

      if (data && data.journey) {
        buildTable(data.journey.filter(journey => journey.rtInfo.status != "NONE"));
      } else {
        console.error('Invalid data format');
      }
    } catch (error) {
      console.error('Error fetching data:', error);
    }
  }

  function getClassForJourney(journey){
      return journey.rtInfo.status
  }

  function buildTable(journeys) {
    const tableContainer = document.getElementById('table-container');
    let tableHTML = '';

    for (let journey of journeys) {
      tableHTML += '<div class="card">';
      tableHTML += `<div class="time ${journey.rtInfo.status.toLowerCase()}">
<h2>${journey.rtInfo && journey.rtInfo.progTime }</h2>
${journey.rtInfo.status.toLowerCase() === "delayed" ? `<h4>${journey.time} +${ journey.rtInfo.progDelay}"</h4>` : ""}
</div>`;
      tableHTML += `<div class="info">
        <h2>${journey.mot.name}</h2>
        <h3>nach ${journey.direction.replace("Hauptbahnhof","Hbf")}</h3>
      </div>`;
      tableHTML += `<div class="gleis"><small>Gleis<br></small>${journey.track.platform}</div>`;
      tableHTML += '</div>';

    }


    tableContainer.innerHTML = tableHTML;
  }

  function setTheme() {
    const storedTheme = localStorage.getItem('theme');
    if (storedTheme) {
      if (storedTheme === 'dark') {
        document.body.classList.add('dark-mode');
      } else {
        document.body.classList.remove('dark-mode');
      }
    } else {
      if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark-mode');
        localStorage.setItem("theme", "dark");
      } else {
        document.body.classList.remove('dark-mode');
        localStorage.setItem("theme", "light");
      }
    }
  }


  window.addEventListener('DOMContentLoaded', (event) => {
    setTheme();
    fetchDataAndBuildTable();
    setInterval( () => fetchDataAndBuildTable(), 60000);
    document.getElementById("change-color").addEventListener("click", () => {
      const storedTheme = localStorage.getItem('theme');

      if(storedTheme === "dark"){
        localStorage.setItem("theme", "light");
      }else{
        localStorage.setItem("theme", "dark");
      }

      setTheme();
    })
  });

  // if ('serviceWorker' in navigator) {
  //   window.addEventListener('load', function() {
  //     navigator.serviceWorker.register('/service-worker.js');
  //   });
  // }
</script>
</body>
</html>
